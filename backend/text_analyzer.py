# backend/text_analyzer.py
import re
import inspect
from collections import namedtuple

# Фикс для Python 3.12: добавляем inspect.getargspec, если его нет
if not hasattr(inspect, "getargspec"):
    ArgSpec = namedtuple("ArgSpec", "args varargs keywords defaults")

    def getargspec(func):
        fs = inspect.getfullargspec(func)
        return ArgSpec(
            args=fs.args,
            varargs=fs.varargs,
            keywords=fs.varkw,
            defaults=fs.defaults,
        )

    inspect.getargspec = getargspec

import pymorphy2

MORPH = pymorphy2.MorphAnalyzer()

# дальше — твой остальной код модуля
from functools import lru_cache
from typing import List, Dict, Tuple
import pymorphy2
from .schemas import CheckResult


# ИНИЦИАЛИЗАЦИЯ МОРФОЛОГИЧЕСКОГО АНАЛИЗАТОРА (один раз на модуль)
MORPH = pymorphy2.MorphAnalyzer()

# 1) ТРИГГЕРЫ (как вы прислали — расширенные списки)
URGENCY_TRIGGERS = [
    "срочно", "срочная", "срочное", "срочные", "срочный",
    "немедленно", "немедленная", "немедленное", "немедленные", "немедленный",
    "незамедлительно", "незамедлительная", "незамедлительное", "незамедлительные", "незамедлительный",
    "требуется срочно", "требуется немедленно", "требуется незамедлительно",
    "нужно срочно", "нужно немедленно", "нужно незамедлительно",
    "необходимо срочно", "необходимо немедленно", "необходимо незамедлительно",
    "быстрее", "скорее", "побыстрее", "поскорее",
    "последний шанс", "последняя возможность", "последнее предложение",
    "ограниченное предложение", "ограниченная акция", "ограниченный срок",
    "действие истекает", "срок истекает", "время истекает",
    "в течение 24 часов", "в течение суток", "в ближайшие 24 часа",
    "до конца дня", "до конца недели", "до конца месяца",
    "срок действия истекает", "срок заканчивается", "время заканчивается",
    "поторопитесь", "торопитесь", "спешите", "поспешите",
    "успейте", "успей", "успевайте",
    "осталось мало времени", "времени мало", "время на исходе",
    "прямо сейчас", "сейчас же", "немедля",
    "предложение скоро закончится", "акция скоро завершится", "срок подходит к концу",
    "не откладывайте", "не откладывай", "не затягивайте",
    "не медлите", "не теряйте времени", "не упустите шанс"
]

THREAT_TRIGGERS = [
    "ваш аккаунт заблокирован", "аккаунт заблокирован", "ваша учетная запись заблокирована",
    "ваш профиль заблокирован", "доступ заблокирован", "блокировка аккаунта",
    "ваш аккаунт будет заблокирован", "аккаунт будет заблокирован",
    "учетная запись будет удалена", "аккаунт будет удален", "профиль будет удален",
    "ваша учетная запись подлежит удалению", "подлежит удалению",
    "подозрительная активность","подозрительной активности", "подозрительные действия", "необычная активность",
    "несанкционированная активность", "подозрительные операции",
    "несанкционированный доступ", "неавторизованный доступ", "несанкционированное проникновение",
    "обнаружена проблема безопасности", "выявлена проблема безопасности",
    "нарушение безопасности", "компрометация безопасности",
    "обнаружена подозрительная попытка входа", "зафиксирована подозрительная попытка входа",
    "подозрительная попытка входа", "несанкционированная попытка входа",
    "ваш пароль истек", "срок действия пароля истек", "пароль устарел",
    "уведомление о безопасности", "оповещение о безопасности", "предупреждение о безопасности",
    "ограничение доступа", "ограничения доступа", "доступ ограничен",
    "учетная запись приостановлена", "аккаунт приостановлен", "приостановка доступа",
    "штраф", "штрафные санкции", "наложение штрафа",
    "судебное уведомление", "судебное предписание", "юридическое уведомление",
    "проблема с вашим заказом", "проблема с заказом", "возникла проблема с заказом",
    "неудачная попытка входа", "неуспешная попытка входа", "попытка входа не удалась"
]

FINANCIAL_TRIGGERS = [
    "вы выиграли", "вы победили", "вы стали победителем",
    "ваш выигрыш", "ваша победа", "поздравляем с выигрышем",
    "приз", "денежный приз", "главный приз", "ценный приз",
    "лотерея", "розыгрыш лотереи", "лотерейный билет",
    "наследство", "получение наследства", "наследственное дело",
    "возврат средств", "возврат денег", "возврат оплаты",
    "возмещение", "финансовое возмещение", "компенсация",
    "получить выплату", "получить деньги", "получить средства",
    "обновите платежные данные", "обновите платежную информацию",
    "проверьте платежные данные", "подтвердите платежные данные",
    "счет-фактура", "инвойс", "выставлен счет",
    "транзакция", "финансовая операция", "денежный перевод",
    "оплата", "произвести оплату", "требуется оплата",
    "денежный приз", "денежное вознаграждение", "финансовое вознаграждение",
    "налоговый вычет", "налоговая льгота", "возврат налогов",
    "эксклюзивное финансовое предложение", "специальное финансовое предложение",
    "инвестиции", "инвестиционное предложение", "выгодные инвестиции",
    "криптовалюта", "криптоактивы", "цифровые активы",
    "ваш счет", "ваш банковский счет", "ваш лицевой счет",
    "требуется оплата", "необходима оплата", "ожидается оплата"
]

PROMO_TRIGGERS = [
    "промокод", "промо-код", "код скидки",
    "купон", "дисконтный купон", "купон на скидку",
    "акция", "специальная акция", "рекламная акция",
    "скидка", "процент скидки", "размер скидки",
    "бонус", "дополнительный бонус", "бонусные баллы",
    "подарок", "бесплатный подарок", "подарок за покупку",
    "бесплатно", "бесплатное предложение", "без оплаты",
    "cashback", "кэшбек", "возврат процента",
    "розыгрыш", "конкурс", "розыгрыш призов",
    "выигрыш", "возможность выиграть", "шанс выиграть",
    "эксклюзивно", "эксклюзивное предложение", "уникальное предложение",
    "только для вас", "персонально для вас", "специально для вас",
    "специальное предложение", "особое предложение", "льготное предложение",
    "промо", "промо-акция", "промо-предложение",
    "выбраны в качестве победителя", "вы стали победителем", "поздравляем победителя"
]

AUTHORITY_TRIGGERS = [
    "от имени службы безопасности", "служба безопасности уведомляет",
    "служба безопасности сообщает", "отдел безопасности",
    "официальное уведомление", "официальное сообщение", "официальное оповещение",
    "официальное предписание", "официальное требование",
    "служба поддержки", "техническая поддержка", "клиентская поддержка",
    "администратор", "системный администратор", "администрация системы",
    "администрация сайта", "администрация портала", "администрация сервиса",
    "госуслуги", "портал госуслуг", "государственные услуги",
    "налоговая служба", "налоговая инспекция", "федеральная налоговая служба",
    "центральный банк", "банк россии", "цб рф",
    "it-отдел", "отдел информационных технологий", "технический отдел",
    "финансовый отдел", "бухгалтерия", "отдел финансов",
    "правоохранительные органы", "органы правопорядка", "полиция",
    "государственная служба", "федеральная служба", "ведомство",
    "служба безопасности", "отдел безопасности", "департамент безопасности"
]

LOGIN_TRIGGERS = [
    "войдите в аккаунт", "войдите в учетную запись", "войдите в систему",
    "авторизуйтесь", "пройдите авторизацию", "выполните вход",
    "подтвердите аккаунт", "подтвердите учетную запись", "активируйте аккаунт",
    "подтвердите email", "подтвердите адрес email", "подтвердите электронную почту",
    "подтвердите почту", "верифицируйте email",
    "сбросить пароль", "восстановить пароль", "изменить пароль",
    "смена пароля", "восстановление доступа",
    "подтвердить личность", "идентификация пользователя", "верификация личности",
    "пройти идентификацию", "пройти верификацию",
    "обновить информацию", "обновить данные", "актуализировать информацию",
    "обновить профиль", "обновить сведения",
    "верификация", "процесс верификации", "проверка данных",
    "подтвердите ваши данные", "проверьте ваши данные", "актуализируйте данные",
    "восстановить доступ", "восстановление доступа", "возобновить доступ",
    "войдите, чтобы продолжить", "авторизуйтесь для продолжения", "войдите для доступа"
]

SOCIAL_TRIGGERS = [
    "вас отметили на фото", "вас отметили на фотографии", "вас тегировали на фото",
    "вас упомянули на фото", "вас пометили на снимке",
    "вы упомянуты в записи", "вас упомянули в посте", "вас упомянули в публикации",
    "ваше имя упомянуто", "вас отметили в записи",
    "кто-то просматривал ваш профиль", "ваш профиль просматривали",
    "посетители вашего профиля", "кто-то заходил на вашу страницу",
    "у вас новое сообщение", "поступило новое сообщение", "непрочитанное сообщение",
    "входящее сообщение", "личное сообщение",
    "запрос на добавление в друзья", "запрос в друзья", "приглашение в друзья",
    "хочет добавить вас в друзья", "новый запрос на дружбу",
    "ваш друг поделился", "друг поделился записью", "друг опубликовал",
    "знакомый поделился", "ваш контакт поделился",
    "комментарий к вашей записи", "комментарий под вашим постом",
    "новый комментарий", "оставлен комментарий",
    "вам отправили файл", "для вас загружен файл", "получен файл",
    "скачать документ", "загрузить документ", "получить документ",
    "прикрепленный файл", "вложенный файл", "приложение к сообщению",
    "посмотрите это видео", "рекомендуем посмотреть видео", "новое видео для вас",
    "интересное видео", "видео для вас"
]

ALL_TRIGGERS: Dict[str, List[str]] = {
    "Давление на срочность": URGENCY_TRIGGERS,
    "Угрозы и запугивание": THREAT_TRIGGERS,
    "Финансовая приманка": FINANCIAL_TRIGGERS,
    "Маркетинговая приманка": PROMO_TRIGGERS,
    "Апелляция к авторитету": AUTHORITY_TRIGGERS,
    "Запрос логина/верификации": LOGIN_TRIGGERS,
    "Социальная приманка / Любопытство": SOCIAL_TRIGGERS,
}

# 2) СЛУЖЕБНЫЕ ФУНКЦИИ

TOKEN_RE = re.compile(r"[A-Za-zА-Яа-яЁё0-9\-]+")

def tokenize(text: str) -> List[str]:
    """Разбиваем текст на «слова» (включая числа и латиницу), приводим к нижнему регистру."""
    return [t.lower() for t in TOKEN_RE.findall(text or "")]

@lru_cache(maxsize=50000)
def lemma(word: str) -> str:
    """Лемма (начальная форма) слова через pymorphy2 (кэшируем для скорости)."""
    if not word:
        return word
    try:
        return MORPH.parse(word)[0].normal_form
    except Exception:
        return word

def lemmatize_tokens(tokens: List[str]) -> List[str]:
    return [lemma(t) for t in tokens]

def phrase_to_lemmas(phrase: str) -> List[str]:
    """Фразу → леммы (последовательность)."""
    return lemmatize_tokens(tokenize(phrase))

def find_phrase_lemmas_in_text(lemmas_text: List[str], phrase_lemmas: List[str]) -> bool:
    """Проверка: встречается ли последовательность лемм фразы как непрерывная подпоследовательность в тексте-леммах."""
    n = len(phrase_lemmas)
    if n == 0 or n > len(lemmas_text):
        return False
    for i in range(len(lemmas_text) - n + 1):
        if lemmas_text[i:i+n] == phrase_lemmas:
            return True
    return False

# Предподготовим триггеры в леммах (для скорости поиска)
TRIGGERS_LEMMA_INDEX: Dict[str, List[Tuple[str, List[str]]]] = {}
for category, phrases in ALL_TRIGGERS.items():
    prepared: List[Tuple[str, List[str]]] = []
    for ph in phrases:
        prepared.append((ph, phrase_to_lemmas(ph)))
    TRIGGERS_LEMMA_INDEX[category] = prepared


def analyze_email_text(text: str) -> CheckResult:
    """Анализирует текст на наличие фишинговых триггеров (по леммам — покрывает все формы слов)."""
    if not text:
        return CheckResult(
            check_name="Text Analysis (NLP)",
            is_suspicious=False,
            details="Текст для анализа отсутствует."
        )

    tokens = tokenize(text)
    lemmas = lemmatize_tokens(tokens)

    found_triggers: List[str] = []

    # Ищем фразы из каждой категории в леммированном тексте
    for category, prepared in TRIGGERS_LEMMA_INDEX.items():
        for original_phrase, phrase_lemmas in prepared:
            if not phrase_lemmas:
                continue
            if find_phrase_lemmas_in_text(lemmas, phrase_lemmas):
                found_triggers.append(f"'{original_phrase}' (категория: {category})")

    if found_triggers:
        unique_triggers = sorted(set(found_triggers))
        details_text = ", ".join(unique_triggers)
        return CheckResult(
            check_name="Text Analysis (NLP)",
            is_suspicious=True,
            details=f"В тексте найдены подозрительные фразы: {details_text}. Они часто используются для манипуляции."
        )

    return CheckResult(
        check_name="Text Analysis (NLP)",
        is_suspicious=False,
        details="Подозрительных слов или фраз в тексте не обнаружено."
    )
